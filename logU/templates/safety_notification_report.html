<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    {% load static %}

    <!-- Website Title -->
    <title>Safety Notification Report - TBSC</title>

    <!-- Styles -->
    <link href="https://fonts.googleapis.com/css?family=Montserrat:500,700&display=swap&subset=latin-ext" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,600&display=swap&subset=latin-ext" rel="stylesheet">
    <link href="{% static 'css1/bootstrap.css' %}" rel="stylesheet">
    <link href="{% static 'css1/fontawesome-all.css' %}" rel="stylesheet">
    <link href="{% static 'css1/styles.css' %}" rel="stylesheet">

    <!-- Favicon  -->
    <link rel="icon" href="{% static 'images/logo1.png' %}">
    <style>
        html, body {
            height: 100%;
        }
        body {
            display: flex;
            flex-direction: column;
            background-color: #FFFFFF;
            color: #333333;
        }
        .navbar-custom {
            background-color: #2C3E50;
            padding: 10px 0;
        }
        .navbar-logo {
            height: 40px;
            width: auto;
            border-radius: 50%;
        }
        .agent-logo {
            height: 40px;
            width: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        .agent-name {
            color: #ffffff;
            font-weight: 600;
            font-size: 1.1rem;
        }
        .dropdown-toggle::after {
            vertical-align: middle;
        }
        .dropdown-menu {
            background-color: #34495E;
            border: none;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .dropdown-item {
            color: #ffffff;
            transition: all 0.3s ease;
        }
        .dropdown-item:hover {
            background-color: #2C3E50;
            color: #1ABC9C;
        }
        .dropdown-divider {
            border-top-color: #4A6278;
        }
        .content {
            flex: 1 0 auto;
            padding-top: 80px;
        }
        .footer {
            flex-shrink: 0;
            background-color: #2C3E50;
            color: #FFFFFF;
            text-align: center;
            padding: 10px 0;
        }
        .form-container {
            background-color: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .form-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
        }
        .form-group label {
            font-weight: bold;
            color: #2C3E50;
            transition: all 0.3s ease;
        }
        .form-control {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .form-control:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }
        .btn-primary {
            background-color: #3498db;
            border: none;
            border-radius: 25px;
            padding: 10px 25px;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        .section-title {
            position: relative;
            padding-bottom: 10px;
            margin-bottom: 20px;
            color: #2C3E50;
        }
        .section-title::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: 0;
            width: 50px;
            height: 3px;
            background-color: #3498db;
            transition: all 0.3s ease;
        }
        .form-container:hover .section-title::after {
            width: 100px;
        }
        .form-icon {
            font-size: 24px;
            color: #3498db;
            margin-right: 10px;
        }
        .locationOption {
            padding: 5px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .locationOption:hover {
            background-color: #f8f9fa;
        }
        .success-animation {
            margin: 20px auto;
        }
        .tick-container {
            width: 80px;
            height: 80px;
            position: relative;
            margin: 0 auto;
        }
        .tick {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-color: #4bb71b;
            opacity: 0;
            position: relative;
            transform: scale(0);
            animation: fill-and-scale 0.5s ease-in-out 0.4s forwards;
        }
        .tick:before, .tick:after {
            content: '';
            background-color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(45deg);
        }
        .tick:before {
            width: 25%;
            height: 10%;
            animation: tick-short 0.3s ease-in-out 0.9s forwards;
        }
        .tick:after {
            width: 50%;
            height: 10%;
            animation: tick-long 0.3s ease-in-out 0.9s forwards;
        }
        @keyframes fill-and-scale {
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        @keyframes tick-short {
            0% {
                width: 0;
                left: 30%;
                top: 60%;
            }
            100% {
                width: 25%;
                left: 40%;
                top: 55%;
            }
        }
        @keyframes tick-long {
            0% {
                width: 0;
                left: 60%;
                top: 45%;
            }
            100% {
                width: 50%;
                left: 55%;
                top: 40%;
            }
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .fade-in-up {
            animation: fadeInUp 0.5s ease-out;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-md navbar-dark navbar-custom fixed-top">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="{% url 'agent_welcome' %}">
                <img src="{% static 'images/airplane.gif' %}" alt="TBSC Logo" class="navbar-logo mr-2">
            </a>
            <div class="ml-auto d-flex align-items-center">
                <img src="{% static 'images/agent.gif' %}" alt="Agent" class="agent-logo mr-2">
                <div class="dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <span class="agent-name">
                            {% if agent %}
                                {{ agent.first_name }} {{ agent.last_name }}
                            {% else %}
                                {{ user.first_name }} {{ user.last_name }}
                            {% endif %}
                        </span>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
                        <a class="dropdown-item" href="{% url 'agent_welcome' %}"><i class="fas fa-tasks"></i> Home</a>
                        <a class="dropdown-item" href="{% url 'safety_notification_report' %}"><i class="fas fa-user-cog"></i> Safety Notification Report</a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="{% url 'signout' %}"><i class="fas fa-sign-out-alt"></i> Logout</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    <!-- end of navbar -->

    <!-- Content -->
    <div class="content">
        <div class="container mt-5">
            {% if messages %}
            <div class="messages">
                {% for message in messages %}
                <div class="alert alert-{% if message.tags %}{{ message.tags }}{% endif %}" role="alert">
                    {{ message }}
                </div>
                {% endfor %}
            </div>
            {% endif %}
            <h2 class="mb-4 text-center fade-in-up">Safety Notification Report</h2>
            <div class="form-container fade-in-up">
                <form action="{% url 'safety_notification_report' %}" method="post" enctype="multipart/form-data" id="safety-report-form">
                    {% csrf_token %}
                    
                    <h4 class="section-title"><i class="fas fa-info-circle form-icon"></i>Report Information</h4>
                    <div class="form-group">
                        <label for="report_title">Report Title</label>
                        <input type="text" class="form-control" id="report_title" name="report_title" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="incident_datetime">Date and Time of Incident</label>
                        <input type="datetime-local" class="form-control" id="incident_datetime" name="incident_datetime" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="location">Location</label>
                        <input type="text" class="form-control" id="location" name="location" required>
                        <input type="hidden" id="latitude" name="latitude">
                        <input type="hidden" id="longitude" name="longitude">
                        <button type="button" id="searchLocation" class="btn btn-secondary mt-2">Search Location</button>
                    </div>
                    <div id="locationResults" class="mt-2"></div>
                    
                    <div class="form-group">
                        <label for="route">Route</label>
                        <input type="text" class="form-control" id="route" name="route" value="{{ route }}" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="bus">Bus</label>
                        <select class="form-control" id="bus" name="bus_id" required>
                            {% if assigned_bus %}
                                <option value="{{ assigned_bus.bus_id }}" selected>
                                    {{ assigned_bus.bus_name }} ({{ assigned_bus.bus_number }})
                                </option>
                            {% else %}
                                <option value="" disabled selected>No active bus assigned</option>
                            {% endif %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="stop">Stop</label>
                        <select class="form-control" id="stop" name="stop" required>
                            {% for stop in all_stops %}
                                <option value="{{ stop }}" {% if stop == assigned_stop %}selected{% endif %}>{{ stop }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <h4 class="section-title mt-4"><i class="fas fa-exclamation-triangle form-icon"></i>Incident Details</h4>
                    <div class="form-group">
                        <label for="incident_type">Type of Incident</label>
                        <input type="text" class="form-control" id="incident_type" name="incident_type" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="severity_level">Severity Level</label>
                        <select class="form-control" id="severity_level" name="severity_level" required>
                            <option value="">Select Severity</option>
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="description">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="4" required></textarea>
                    </div>
                    
                    <h4 class="section-title mt-4"><i class="fas fa-camera form-icon"></i>Supporting Media</h4>
                    <div class="form-group">
                        <label for="files">Upload Images/Files</label>
                        <input type="file" class="form-control-file" id="files" name="files[]" multiple>
                    </div>
                    
                    <h4 class="section-title mt-4"><i class="fas fa-user form-icon"></i>Agent Information</h4>
                    <div class="form-group">
                        <label for="agent_name">Agent Name</label>
                        <input type="text" class="form-control" id="agent_name" name="agent_name" value="{% if agent %}{{ agent.first_name }} {{ agent.last_name }}{% else %}{{ user.first_name }} {{ user.last_name }}{% endif %}" readonly>
                    </div>
                    <div class="form-group">
                        <label for="agent_id">Agent ID/Code</label>
                        <input type="text" class="form-control" id="agent_id" name="agent_id" value="{{ agent_id }}" readonly>
                    </div>
                    <div class="form-group">
                        <label for="contact_info">Contact Information</label>
                        <input type="text" class="form-control" id="contact_info" name="contact_info" value="{{ contact_info }}" readonly>
                    </div>
                    
                    <div class="mt-4 text-center">
                        <button type="submit" class="btn btn-primary" id="submitReport">
                            <i class="fas fa-paper-plane mr-2"></i>Submit Report
                        </button>
                        <a href="{% url 'agent_welcome' %}" class="btn btn-danger ml-2">
                            <i class="fas fa-times mr-2"></i>Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1" role="dialog" aria-labelledby="successModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <div class="success-animation">
                        <div class="tick-container">
                            <div class="tick"></div>
                        </div>
                    </div>
                    <h4 class="mt-3">Report Submitted Successfully</h4>
                    <p>Thank you for your submission.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p class="p-small">&copy; 2024 TBSC. All rights reserved.</p>
    </footer>
    <!-- end of footer -->

    <!-- Scripts -->
    <script src="{% static 'js1/jquery.min.js' %}"></script>
    <script src="{% static 'js1/popper.min.js' %}"></script>
    <script src="{% static 'js1/bootstrap.min.js' %}"></script>
    <script>
    $(document).ready(function() {
        $('#searchLocation').click(function() {
            const query = $('#location').val();
            $.ajax({
                url: 'https://google-map-places.p.rapidapi.com/maps/api/place/findplacefromtext/json',
                data: {
                    input: query,
                    inputtype: 'textquery',
                    fields: 'formatted_address,name,geometry',
                    language: 'en'
                },
                headers: {
                    'x-rapidapi-host': 'google-map-places.p.rapidapi.com',
                    'x-rapidapi-key': '4d66294cbcmsh594b3f8a9709b1ap197cadjsn230e8c3bf106'
                },
                method: 'GET',
                dataType: 'json',
                success: function(response) {
                    let results = '';
                    if (response.candidates && response.candidates.length > 0) {
                        response.candidates.forEach(function(place) {
                            results += `<div class="locationOption" data-lat="${place.geometry.location.lat}" data-lng="${place.geometry.location.lng}">
                                            ${place.formatted_address || place.name}
                                        </div>`;
                        });
                    } else {
                        results = '<p>No results found</p>';
                    }
                    $('#locationResults').html(results);
                },
                error: function(xhr) {
                    console.log('Error:', xhr);
                    $('#locationResults').html('<p>An error occurred while searching for locations</p>');
                }
            });
        });

        $(document).on('click', '.locationOption', function() {
            const lat = $(this).data('lat');
            const lng = $(this).data('lng');
            const address = $(this).text();

            $('#location').val(address);
            $('#latitude').val(lat);
            $('#longitude').val(lng);
            $('#locationResults').empty();
        });

        // Prevent form submission and show modal
        $('form').on('submit', function(e) {
            e.preventDefault();
            $('#successModal').modal('show');
            
            // Optional: Submit the form after a delay
            setTimeout(function() {
                $('form')[0].submit();
            }, 2000); // Adjust the delay as needed
        });

        // Add fade-in effect to form sections
        $('.section-title').each(function(index) {
            $(this).addClass('fade-in-up').css('animation-delay', (index * 0.1) + 's');
        });

        // Add hover effect to form fields
        $('.form-control').hover(
            function() { $(this).css('transform', 'scale(1.02)'); },
            function() { $(this).css('transform', 'scale(1)'); }
        );

        $('#safety-report-form').submit(function(e) {
            e.preventDefault();
            var formData = new FormData(this);
            
            $('#submitReport').prop('disabled', true);
            
            $.ajax({
                url: $(this).attr('action'),
                type: 'POST',
                data: formData,
                success: function(response) {
                    if (response.status === 'success') {
                        $('#successModal').modal('show');
                        setTimeout(function() {
                            window.location.href = '{% url "agent_welcome" %}';
                        }, 2000);
                    } else {
                        alert('Error: ' + (response.message || 'Unknown error occurred'));
                        $('#submitReport').prop('disabled', false);
                    }
                },
                error: function(xhr, status, error) {
                    var errorMessage = 'An error occurred while submitting the report.';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage += ' ' + xhr.responseJSON.message;
                    }
                    alert(errorMessage);
                    $('#submitReport').prop('disabled', false);
                },
                cache: false,
                contentType: false,
                processData: false
            });
        });

        // Remove any previous form submission handlers
        $('form').off('submit');
    });
    </script>
</body>
</html>